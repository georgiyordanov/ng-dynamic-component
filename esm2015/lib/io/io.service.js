import { ChangeDetectorRef, ComponentFactoryResolver, Inject, Injectable, KeyValueDiffers, } from '@angular/core';
import { Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import { createChange, createNewChange, noop } from '../util';
import { EventArgumentToken } from './event-argument';
export class IoService {
    constructor(differs, cfr, eventArgument, cdr) {
        this.differs = differs;
        this.cfr = cfr;
        this.eventArgument = eventArgument;
        this.cdr = cdr;
        this.checkInit = this.failInit;
        this.lastComponentInst = null;
        this.inputsDiffer = this.differs.find({}).create();
        this.compFactory = null;
        this.outputsShouldDisconnect$ = new Subject();
        this.outputsChanged = () => false;
    }
    get compRef() {
        return this.compInjector.componentRef;
    }
    get componentInst() {
        return this.compRef ? this.compRef.instance : null;
    }
    get componentInstChanged() {
        if (this.lastComponentInst !== this.componentInst) {
            this.lastComponentInst = this.componentInst;
            return true;
        }
        else {
            return false;
        }
    }
    get compCdr() {
        // tslint:disable-next-line: deprecation
        return this.compRef ? this.compRef.injector.get(ChangeDetectorRef) : null;
    }
    ngOnDestroy() {
        this._disconnectOutputs();
    }
    init(componentInjector, options = {}) {
        this.checkInit = componentInjector ? noop : this.failInit;
        this.compInjector = componentInjector;
        if (options.trackOutputChanges) {
            const outputsDiffer = this.differs.find({}).create();
            this.outputsChanged = outputs => !!outputsDiffer.diff(outputs);
        }
    }
    update(inputs, outputs, inputsChanged, outputsChanged) {
        this.checkInit();
        this.updateIO(inputs, outputs);
        const compChanged = this.componentInstChanged;
        if (compChanged || inputsChanged) {
            const inputsChanges = this._getInputsChanges();
            if (inputsChanges) {
                this._updateInputChanges(inputsChanges);
            }
            this.updateInputs(compChanged || !this.lastInputChanges);
        }
        if (compChanged || outputsChanged) {
            this.bindOutputs();
        }
    }
    maybeUpdate() {
        this.checkInit();
        if (this.componentInstChanged) {
            this.updateInputs(true);
            this.bindOutputs();
            return;
        }
        if (this.outputsChanged(this.outputs)) {
            this.bindOutputs();
        }
        if (!this.inputs) {
            return;
        }
        const inputsChanges = this._getInputsChanges();
        if (inputsChanges) {
            const isNotFirstChange = !!this.lastInputChanges;
            this._updateInputChanges(inputsChanges);
            if (isNotFirstChange) {
                this.updateInputs();
            }
        }
    }
    updateIO(inputs, outputs) {
        this.inputs = inputs;
        this.outputs = outputs;
    }
    updateInputs(isFirstChange = false) {
        if (isFirstChange) {
            this._updateCompFactory();
        }
        const compInst = this.componentInst;
        let inputs = this.inputs;
        if (!inputs || !compInst) {
            return;
        }
        inputs = this._resolveInputs(inputs);
        Object.keys(inputs).forEach(p => (compInst[p] = inputs[p]));
        // Mark component for check to re-render with new inputs
        if (this.compCdr) {
            this.compCdr.markForCheck();
        }
        this.notifyOnInputChanges(this.lastInputChanges, isFirstChange);
    }
    bindOutputs() {
        this._disconnectOutputs();
        const compInst = this.componentInst;
        let outputs = this.outputs;
        if (!outputs || !compInst) {
            return;
        }
        outputs = this._resolveOutputs(outputs);
        Object.keys(outputs)
            .filter(p => compInst[p])
            .forEach(p => compInst[p]
            .pipe(takeUntil(this.outputsShouldDisconnect$))
            .subscribe((event) => {
            this.cdr.markForCheck();
            return outputs[p](event);
        }));
    }
    notifyOnInputChanges(changes = {}, forceFirstChanges) {
        // Exit early if component not interested to receive changes
        if (!this.componentInst.ngOnChanges) {
            return;
        }
        if (forceFirstChanges) {
            changes = this._collectFirstChanges();
        }
        this.componentInst.ngOnChanges(changes);
    }
    _disconnectOutputs() {
        this.outputsShouldDisconnect$.next();
    }
    _getInputsChanges() {
        return this.inputsDiffer.diff(this.inputs);
    }
    _updateInputChanges(differ) {
        this.lastInputChanges = this._collectChangesFromDiffer(differ);
    }
    _collectFirstChanges() {
        const changes = {};
        const inputs = this.inputs;
        Object.keys(inputs).forEach(prop => (changes[prop] = createNewChange(inputs[prop])));
        return this._resolveChanges(changes);
    }
    _collectChangesFromDiffer(differ) {
        const changes = {};
        differ.forEachAddedItem(record => (changes[record.key] = createNewChange(record.currentValue)));
        differ.forEachChangedItem(record => (changes[record.key] = createChange(record.currentValue, record.previousValue)));
        return this._resolveChanges(changes);
    }
    _resolveCompFactory() {
        try {
            try {
                return this.cfr.resolveComponentFactory(this.compRef.componentType);
            }
            catch (e) {
                // Fallback if componentType does not exist (happens on NgComponentOutlet)
                return this.cfr.resolveComponentFactory(this.compRef.instance.constructor);
            }
        }
        catch (e) {
            // Factory not available - bailout
            return null;
        }
    }
    _updateCompFactory() {
        this.compFactory = this._resolveCompFactory();
    }
    _resolveInputs(inputs) {
        if (!this.compFactory) {
            return inputs;
        }
        return this._remapIO(inputs, this.compFactory.inputs);
    }
    _resolveOutputs(outputs) {
        outputs = this._processOutputs(outputs);
        if (!this.compFactory) {
            return outputs;
        }
        return this._remapIO(outputs, this.compFactory.outputs);
    }
    _processOutputs(outputs) {
        const processedOutputs = {};
        Object.keys(outputs).forEach(key => {
            const outputExpr = outputs[key];
            if (typeof outputExpr === 'function') {
                processedOutputs[key] = outputExpr;
            }
            else {
                processedOutputs[key] =
                    outputExpr && this._processOutputArgs(outputExpr);
            }
        });
        return processedOutputs;
    }
    _processOutputArgs(output) {
        const { handler } = output;
        const args = 'args' in output ? output.args || [] : [this.eventArgument];
        return event => handler(...args.map(arg => (arg === this.eventArgument ? event : arg)));
    }
    _resolveChanges(changes) {
        if (!this.compFactory) {
            return changes;
        }
        return this._remapIO(changes, this.compFactory.inputs);
    }
    _remapIO(io, mapping) {
        const newIO = {};
        Object.keys(io).forEach(key => {
            const newKey = this._findPropByTplInMapping(key, mapping) || key;
            newIO[newKey] = io[key];
        });
        return newIO;
    }
    _findPropByTplInMapping(tplName, mapping) {
        for (const map of mapping) {
            if (map.templateName === tplName) {
                return map.propName;
            }
        }
        return null;
    }
    failInit() {
        throw Error('IoService: ComponentInjector was not set! Please call init() method!');
    }
}
IoService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
IoService.ctorParameters = () => [
    { type: KeyValueDiffers },
    { type: ComponentFactoryResolver },
    { type: String, decorators: [{ type: Inject, args: [EventArgumentToken,] }] },
    { type: ChangeDetectorRef }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW8uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25nLWR5bmFtaWMtY29tcG9uZW50L3NyYy9saWIvaW8vaW8uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsaUJBQWlCLEVBRWpCLHdCQUF3QixFQUN4QixNQUFNLEVBQ04sVUFBVSxFQUVWLGVBQWUsR0FHaEIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHM0MsT0FBTyxFQUFFLFlBQVksRUFBRSxlQUFlLEVBQUUsSUFBSSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQzlELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBbUJ0RCxNQUFNLE9BQU8sU0FBUztJQW9DcEIsWUFDVSxPQUF3QixFQUN4QixHQUE2QixFQUU3QixhQUFxQixFQUNyQixHQUFzQjtRQUp0QixZQUFPLEdBQVAsT0FBTyxDQUFpQjtRQUN4QixRQUFHLEdBQUgsR0FBRyxDQUEwQjtRQUU3QixrQkFBYSxHQUFiLGFBQWEsQ0FBUTtRQUNyQixRQUFHLEdBQUgsR0FBRyxDQUFtQjtRQXhDeEIsY0FBUyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7UUFFMUIsc0JBQWlCLEdBQVEsSUFBSSxDQUFDO1FBRTlCLGlCQUFZLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDOUMsZ0JBQVcsR0FBaUMsSUFBSSxDQUFDO1FBQ2pELDZCQUF3QixHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7UUFLL0MsbUJBQWMsR0FBc0MsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDO0lBOEJyRSxDQUFDO0lBNUJKLElBQVksT0FBTztRQUNqQixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDO0lBQ3hDLENBQUM7SUFFRCxJQUFZLGFBQWE7UUFDdkIsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0lBQ3JELENBQUM7SUFFRCxJQUFZLG9CQUFvQjtRQUM5QixJQUFJLElBQUksQ0FBQyxpQkFBaUIsS0FBSyxJQUFJLENBQUMsYUFBYSxFQUFFO1lBQ2pELElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDO1lBQzVDLE9BQU8sSUFBSSxDQUFDO1NBQ2I7YUFBTTtZQUNMLE9BQU8sS0FBSyxDQUFDO1NBQ2Q7SUFDSCxDQUFDO0lBRUQsSUFBWSxPQUFPO1FBQ2pCLHdDQUF3QztRQUN4QyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDNUUsQ0FBQztJQVVELFdBQVc7UUFDVCxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztJQUM1QixDQUFDO0lBRUQsSUFBSSxDQUNGLGlCQUEyQyxFQUMzQyxVQUF5QixFQUFFO1FBRTNCLElBQUksQ0FBQyxTQUFTLEdBQUcsaUJBQWlCLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUMxRCxJQUFJLENBQUMsWUFBWSxHQUFHLGlCQUFpQixDQUFDO1FBRXRDLElBQUksT0FBTyxDQUFDLGtCQUFrQixFQUFFO1lBQzlCLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ3JELElBQUksQ0FBQyxjQUFjLEdBQUcsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUNoRTtJQUNILENBQUM7SUFFRCxNQUFNLENBQ0osTUFBa0IsRUFDbEIsT0FBb0IsRUFDcEIsYUFBc0IsRUFDdEIsY0FBdUI7UUFFdkIsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBRS9CLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQztRQUU5QyxJQUFJLFdBQVcsSUFBSSxhQUFhLEVBQUU7WUFDaEMsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7WUFDL0MsSUFBSSxhQUFhLEVBQUU7Z0JBQ2pCLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxhQUFhLENBQUMsQ0FBQzthQUN6QztZQUNELElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxJQUFJLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7U0FDMUQ7UUFFRCxJQUFJLFdBQVcsSUFBSSxjQUFjLEVBQUU7WUFDakMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1NBQ3BCO0lBQ0gsQ0FBQztJQUVELFdBQVc7UUFDVCxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7UUFFakIsSUFBSSxJQUFJLENBQUMsb0JBQW9CLEVBQUU7WUFDN0IsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN4QixJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDbkIsT0FBTztTQUNSO1FBRUQsSUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUNyQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7U0FDcEI7UUFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNoQixPQUFPO1NBQ1I7UUFFRCxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUUvQyxJQUFJLGFBQWEsRUFBRTtZQUNqQixNQUFNLGdCQUFnQixHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUM7WUFDakQsSUFBSSxDQUFDLG1CQUFtQixDQUFDLGFBQWEsQ0FBQyxDQUFDO1lBRXhDLElBQUksZ0JBQWdCLEVBQUU7Z0JBQ3BCLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQzthQUNyQjtTQUNGO0lBQ0gsQ0FBQztJQUVPLFFBQVEsQ0FBQyxNQUFrQixFQUFFLE9BQW9CO1FBQ3ZELElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO0lBQ3pCLENBQUM7SUFFTyxZQUFZLENBQUMsYUFBYSxHQUFHLEtBQUs7UUFDeEMsSUFBSSxhQUFhLEVBQUU7WUFDakIsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7U0FDM0I7UUFFRCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDO1FBQ3BDLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7UUFFekIsSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUN4QixPQUFPO1NBQ1I7UUFFRCxNQUFNLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUVyQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDNUQsd0RBQXdEO1FBQ3hELElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNoQixJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRSxDQUFDO1NBQzdCO1FBRUQsSUFBSSxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxhQUFhLENBQUMsQ0FBQztJQUNsRSxDQUFDO0lBRU8sV0FBVztRQUNqQixJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztRQUUxQixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDO1FBQ3BDLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7UUFFM0IsSUFBSSxDQUFDLE9BQU8sSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUN6QixPQUFPO1NBQ1I7UUFFRCxPQUFPLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUV4QyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQzthQUNqQixNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDeEIsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQ1gsUUFBUSxDQUFDLENBQUMsQ0FBQzthQUNSLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLHdCQUF3QixDQUFDLENBQUM7YUFDOUMsU0FBUyxDQUFDLENBQUMsS0FBVSxFQUFFLEVBQUU7WUFDeEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUN4QixPQUFRLE9BQU8sQ0FBQyxDQUFDLENBQWtCLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDN0MsQ0FBQyxDQUFDLENBQ0wsQ0FBQztJQUNOLENBQUM7SUFFTyxvQkFBb0IsQ0FDMUIsVUFBeUIsRUFBRSxFQUMzQixpQkFBMEI7UUFFMUIsNERBQTREO1FBQzVELElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLFdBQVcsRUFBRTtZQUNuQyxPQUFPO1NBQ1I7UUFFRCxJQUFJLGlCQUFpQixFQUFFO1lBQ3JCLE9BQU8sR0FBRyxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztTQUN2QztRQUVELElBQUksQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzFDLENBQUM7SUFFTyxrQkFBa0I7UUFDeEIsSUFBSSxDQUFDLHdCQUF3QixDQUFDLElBQUksRUFBRSxDQUFDO0lBQ3ZDLENBQUM7SUFFTyxpQkFBaUI7UUFDdkIsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUVPLG1CQUFtQixDQUFDLE1BQTBCO1FBQ3BELElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUMseUJBQXlCLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDakUsQ0FBQztJQUVPLG9CQUFvQjtRQUMxQixNQUFNLE9BQU8sR0FBRyxFQUFtQixDQUFDO1FBQ3BDLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7UUFFM0IsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQ3pCLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsZUFBZSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQ3hELENBQUM7UUFFRixPQUFPLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDdkMsQ0FBQztJQUVPLHlCQUF5QixDQUFDLE1BQTBCO1FBQzFELE1BQU0sT0FBTyxHQUFrQixFQUFFLENBQUM7UUFFbEMsTUFBTSxDQUFDLGdCQUFnQixDQUNyQixNQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxlQUFlLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQ3ZFLENBQUM7UUFFRixNQUFNLENBQUMsa0JBQWtCLENBQ3ZCLE1BQU0sQ0FBQyxFQUFFLENBQ1AsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLFlBQVksQ0FDakMsTUFBTSxDQUFDLFlBQVksRUFDbkIsTUFBTSxDQUFDLGFBQWEsQ0FDckIsQ0FBQyxDQUNMLENBQUM7UUFFRixPQUFPLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDdkMsQ0FBQztJQUVPLG1CQUFtQjtRQUN6QixJQUFJO1lBQ0YsSUFBSTtnQkFDRixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsdUJBQXVCLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQzthQUNyRTtZQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUNWLDBFQUEwRTtnQkFDMUUsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLHVCQUF1QixDQUNyQyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQ2xDLENBQUM7YUFDSDtTQUNGO1FBQUMsT0FBTyxDQUFDLEVBQUU7WUFDVixrQ0FBa0M7WUFDbEMsT0FBTyxJQUFJLENBQUM7U0FDYjtJQUNILENBQUM7SUFFTyxrQkFBa0I7UUFDeEIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztJQUNoRCxDQUFDO0lBRU8sY0FBYyxDQUFDLE1BQWtCO1FBQ3ZDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQ3JCLE9BQU8sTUFBTSxDQUFDO1NBQ2Y7UUFFRCxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDeEQsQ0FBQztJQUVPLGVBQWUsQ0FBQyxPQUFvQjtRQUMxQyxPQUFPLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUV4QyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNyQixPQUFPLE9BQU8sQ0FBQztTQUNoQjtRQUVELE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUMxRCxDQUFDO0lBRU8sZUFBZSxDQUFDLE9BQW9CO1FBQzFDLE1BQU0sZ0JBQWdCLEdBQXlCLEVBQUUsQ0FBQztRQUVsRCxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUNqQyxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7WUFFaEMsSUFBSSxPQUFPLFVBQVUsS0FBSyxVQUFVLEVBQUU7Z0JBQ3BDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxHQUFHLFVBQVUsQ0FBQzthQUNwQztpQkFBTTtnQkFDTCxnQkFBZ0IsQ0FBQyxHQUFHLENBQUM7b0JBQ25CLFVBQVUsSUFBSSxJQUFJLENBQUMsa0JBQWtCLENBQUMsVUFBVSxDQUFDLENBQUM7YUFDckQ7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sZ0JBQWdCLENBQUM7SUFDMUIsQ0FBQztJQUVPLGtCQUFrQixDQUFDLE1BQXNCO1FBQy9DLE1BQU0sRUFBRSxPQUFPLEVBQUUsR0FBRyxNQUFNLENBQUM7UUFDM0IsTUFBTSxJQUFJLEdBQUcsTUFBTSxJQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBRXpFLE9BQU8sS0FBSyxDQUFDLEVBQUUsQ0FDYixPQUFPLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLEtBQUssSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDNUUsQ0FBQztJQUVPLGVBQWUsQ0FBQyxPQUFzQjtRQUM1QyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNyQixPQUFPLE9BQU8sQ0FBQztTQUNoQjtRQUVELE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBRU8sUUFBUSxDQUNkLEVBQUssRUFDTCxPQUFzQjtRQUV0QixNQUFNLEtBQUssR0FBRyxFQUFFLENBQUM7UUFFakIsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDNUIsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLHVCQUF1QixDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsSUFBSSxHQUFHLENBQUM7WUFDakUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMxQixDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sS0FBVSxDQUFDO0lBQ3BCLENBQUM7SUFFTyx1QkFBdUIsQ0FDN0IsT0FBZSxFQUNmLE9BQXNCO1FBRXRCLEtBQUssTUFBTSxHQUFHLElBQUksT0FBTyxFQUFFO1lBQ3pCLElBQUksR0FBRyxDQUFDLFlBQVksS0FBSyxPQUFPLEVBQUU7Z0JBQ2hDLE9BQU8sR0FBRyxDQUFDLFFBQVEsQ0FBQzthQUNyQjtTQUNGO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRU8sUUFBUTtRQUNkLE1BQU0sS0FBSyxDQUNULHNFQUFzRSxDQUN2RSxDQUFDO0lBQ0osQ0FBQzs7O1lBclVGLFVBQVU7Ozs7WUEzQlQsZUFBZTtZQUpmLHdCQUF3Qjt5Q0F1RXJCLE1BQU0sU0FBQyxrQkFBa0I7WUF6RTVCLGlCQUFpQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENoYW5nZURldGVjdG9yUmVmLFxuICBDb21wb25lbnRGYWN0b3J5LFxuICBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gIEluamVjdCxcbiAgSW5qZWN0YWJsZSxcbiAgS2V5VmFsdWVDaGFuZ2VzLFxuICBLZXlWYWx1ZURpZmZlcnMsXG4gIE9uRGVzdHJveSxcbiAgU2ltcGxlQ2hhbmdlcyxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IER5bmFtaWNDb21wb25lbnRJbmplY3RvciB9IGZyb20gJy4uL2NvbXBvbmVudC1pbmplY3Rvcic7XG5pbXBvcnQgeyBjcmVhdGVDaGFuZ2UsIGNyZWF0ZU5ld0NoYW5nZSwgbm9vcCB9IGZyb20gJy4uL3V0aWwnO1xuaW1wb3J0IHsgRXZlbnRBcmd1bWVudFRva2VuIH0gZnJvbSAnLi9ldmVudC1hcmd1bWVudCc7XG5pbXBvcnQgeyBFdmVudEhhbmRsZXIsIElucHV0c1R5cGUsIE91dHB1dHNUeXBlLCBPdXRwdXRXaXRoQXJncyB9IGZyb20gJy4vdHlwZXMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIElPTWFwSW5mbyB7XG4gIHByb3BOYW1lOiBzdHJpbmc7XG4gIHRlbXBsYXRlTmFtZTogc3RyaW5nO1xufVxuZXhwb3J0IHR5cGUgSU9NYXBwaW5nTGlzdCA9IElPTWFwSW5mb1tdO1xuZXhwb3J0IHR5cGUgS2V5VmFsdWVDaGFuZ2VzQW55ID0gS2V5VmFsdWVDaGFuZ2VzPGFueSwgYW55PjtcblxuZXhwb3J0IGludGVyZmFjZSBJb0luaXRPcHRpb25zIHtcbiAgdHJhY2tPdXRwdXRDaGFuZ2VzPzogYm9vbGVhbjtcbn1cblxuaW50ZXJmYWNlIE91dHB1dHNUeXBlUHJvY2Vzc2VkIGV4dGVuZHMgT3V0cHV0c1R5cGUge1xuICBbazogc3RyaW5nXTogRXZlbnRIYW5kbGVyO1xufVxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgSW9TZXJ2aWNlIGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgcHJpdmF0ZSBjaGVja0luaXQgPSB0aGlzLmZhaWxJbml0O1xuXG4gIHByaXZhdGUgbGFzdENvbXBvbmVudEluc3Q6IGFueSA9IG51bGw7XG4gIHByaXZhdGUgbGFzdElucHV0Q2hhbmdlczogU2ltcGxlQ2hhbmdlcztcbiAgcHJpdmF0ZSBpbnB1dHNEaWZmZXIgPSB0aGlzLmRpZmZlcnMuZmluZCh7fSkuY3JlYXRlKCk7XG4gIHByaXZhdGUgY29tcEZhY3Rvcnk6IENvbXBvbmVudEZhY3Rvcnk8YW55PiB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIG91dHB1dHNTaG91bGREaXNjb25uZWN0JCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG5cbiAgcHJpdmF0ZSBpbnB1dHM6IElucHV0c1R5cGU7XG4gIHByaXZhdGUgb3V0cHV0czogT3V0cHV0c1R5cGU7XG4gIHByaXZhdGUgY29tcEluamVjdG9yOiBEeW5hbWljQ29tcG9uZW50SW5qZWN0b3I7XG4gIHByaXZhdGUgb3V0cHV0c0NoYW5nZWQ6IChvdXRwdXRzOiBPdXRwdXRzVHlwZSkgPT4gYm9vbGVhbiA9ICgpID0+IGZhbHNlO1xuXG4gIHByaXZhdGUgZ2V0IGNvbXBSZWYoKSB7XG4gICAgcmV0dXJuIHRoaXMuY29tcEluamVjdG9yLmNvbXBvbmVudFJlZjtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0IGNvbXBvbmVudEluc3QoKSB7XG4gICAgcmV0dXJuIHRoaXMuY29tcFJlZiA/IHRoaXMuY29tcFJlZi5pbnN0YW5jZSA6IG51bGw7XG4gIH1cblxuICBwcml2YXRlIGdldCBjb21wb25lbnRJbnN0Q2hhbmdlZCgpOiBib29sZWFuIHtcbiAgICBpZiAodGhpcy5sYXN0Q29tcG9uZW50SW5zdCAhPT0gdGhpcy5jb21wb25lbnRJbnN0KSB7XG4gICAgICB0aGlzLmxhc3RDb21wb25lbnRJbnN0ID0gdGhpcy5jb21wb25lbnRJbnN0O1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldCBjb21wQ2RyKCk6IENoYW5nZURldGVjdG9yUmVmIHtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IGRlcHJlY2F0aW9uXG4gICAgcmV0dXJuIHRoaXMuY29tcFJlZiA/IHRoaXMuY29tcFJlZi5pbmplY3Rvci5nZXQoQ2hhbmdlRGV0ZWN0b3JSZWYpIDogbnVsbDtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgZGlmZmVyczogS2V5VmFsdWVEaWZmZXJzLFxuICAgIHByaXZhdGUgY2ZyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gICAgQEluamVjdChFdmVudEFyZ3VtZW50VG9rZW4pXG4gICAgcHJpdmF0ZSBldmVudEFyZ3VtZW50OiBzdHJpbmcsXG4gICAgcHJpdmF0ZSBjZHI6IENoYW5nZURldGVjdG9yUmVmLFxuICApIHt9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5fZGlzY29ubmVjdE91dHB1dHMoKTtcbiAgfVxuXG4gIGluaXQoXG4gICAgY29tcG9uZW50SW5qZWN0b3I6IER5bmFtaWNDb21wb25lbnRJbmplY3RvcixcbiAgICBvcHRpb25zOiBJb0luaXRPcHRpb25zID0ge30sXG4gICkge1xuICAgIHRoaXMuY2hlY2tJbml0ID0gY29tcG9uZW50SW5qZWN0b3IgPyBub29wIDogdGhpcy5mYWlsSW5pdDtcbiAgICB0aGlzLmNvbXBJbmplY3RvciA9IGNvbXBvbmVudEluamVjdG9yO1xuXG4gICAgaWYgKG9wdGlvbnMudHJhY2tPdXRwdXRDaGFuZ2VzKSB7XG4gICAgICBjb25zdCBvdXRwdXRzRGlmZmVyID0gdGhpcy5kaWZmZXJzLmZpbmQoe30pLmNyZWF0ZSgpO1xuICAgICAgdGhpcy5vdXRwdXRzQ2hhbmdlZCA9IG91dHB1dHMgPT4gISFvdXRwdXRzRGlmZmVyLmRpZmYob3V0cHV0cyk7XG4gICAgfVxuICB9XG5cbiAgdXBkYXRlKFxuICAgIGlucHV0czogSW5wdXRzVHlwZSxcbiAgICBvdXRwdXRzOiBPdXRwdXRzVHlwZSxcbiAgICBpbnB1dHNDaGFuZ2VkOiBib29sZWFuLFxuICAgIG91dHB1dHNDaGFuZ2VkOiBib29sZWFuLFxuICApIHtcbiAgICB0aGlzLmNoZWNrSW5pdCgpO1xuICAgIHRoaXMudXBkYXRlSU8oaW5wdXRzLCBvdXRwdXRzKTtcblxuICAgIGNvbnN0IGNvbXBDaGFuZ2VkID0gdGhpcy5jb21wb25lbnRJbnN0Q2hhbmdlZDtcblxuICAgIGlmIChjb21wQ2hhbmdlZCB8fCBpbnB1dHNDaGFuZ2VkKSB7XG4gICAgICBjb25zdCBpbnB1dHNDaGFuZ2VzID0gdGhpcy5fZ2V0SW5wdXRzQ2hhbmdlcygpO1xuICAgICAgaWYgKGlucHV0c0NoYW5nZXMpIHtcbiAgICAgICAgdGhpcy5fdXBkYXRlSW5wdXRDaGFuZ2VzKGlucHV0c0NoYW5nZXMpO1xuICAgICAgfVxuICAgICAgdGhpcy51cGRhdGVJbnB1dHMoY29tcENoYW5nZWQgfHwgIXRoaXMubGFzdElucHV0Q2hhbmdlcyk7XG4gICAgfVxuXG4gICAgaWYgKGNvbXBDaGFuZ2VkIHx8IG91dHB1dHNDaGFuZ2VkKSB7XG4gICAgICB0aGlzLmJpbmRPdXRwdXRzKCk7XG4gICAgfVxuICB9XG5cbiAgbWF5YmVVcGRhdGUoKSB7XG4gICAgdGhpcy5jaGVja0luaXQoKTtcblxuICAgIGlmICh0aGlzLmNvbXBvbmVudEluc3RDaGFuZ2VkKSB7XG4gICAgICB0aGlzLnVwZGF0ZUlucHV0cyh0cnVlKTtcbiAgICAgIHRoaXMuYmluZE91dHB1dHMoKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5vdXRwdXRzQ2hhbmdlZCh0aGlzLm91dHB1dHMpKSB7XG4gICAgICB0aGlzLmJpbmRPdXRwdXRzKCk7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLmlucHV0cykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGlucHV0c0NoYW5nZXMgPSB0aGlzLl9nZXRJbnB1dHNDaGFuZ2VzKCk7XG5cbiAgICBpZiAoaW5wdXRzQ2hhbmdlcykge1xuICAgICAgY29uc3QgaXNOb3RGaXJzdENoYW5nZSA9ICEhdGhpcy5sYXN0SW5wdXRDaGFuZ2VzO1xuICAgICAgdGhpcy5fdXBkYXRlSW5wdXRDaGFuZ2VzKGlucHV0c0NoYW5nZXMpO1xuXG4gICAgICBpZiAoaXNOb3RGaXJzdENoYW5nZSkge1xuICAgICAgICB0aGlzLnVwZGF0ZUlucHV0cygpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlSU8oaW5wdXRzOiBJbnB1dHNUeXBlLCBvdXRwdXRzOiBPdXRwdXRzVHlwZSkge1xuICAgIHRoaXMuaW5wdXRzID0gaW5wdXRzO1xuICAgIHRoaXMub3V0cHV0cyA9IG91dHB1dHM7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZUlucHV0cyhpc0ZpcnN0Q2hhbmdlID0gZmFsc2UpIHtcbiAgICBpZiAoaXNGaXJzdENoYW5nZSkge1xuICAgICAgdGhpcy5fdXBkYXRlQ29tcEZhY3RvcnkoKTtcbiAgICB9XG5cbiAgICBjb25zdCBjb21wSW5zdCA9IHRoaXMuY29tcG9uZW50SW5zdDtcbiAgICBsZXQgaW5wdXRzID0gdGhpcy5pbnB1dHM7XG5cbiAgICBpZiAoIWlucHV0cyB8fCAhY29tcEluc3QpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpbnB1dHMgPSB0aGlzLl9yZXNvbHZlSW5wdXRzKGlucHV0cyk7XG5cbiAgICBPYmplY3Qua2V5cyhpbnB1dHMpLmZvckVhY2gocCA9PiAoY29tcEluc3RbcF0gPSBpbnB1dHNbcF0pKTtcbiAgICAvLyBNYXJrIGNvbXBvbmVudCBmb3IgY2hlY2sgdG8gcmUtcmVuZGVyIHdpdGggbmV3IGlucHV0c1xuICAgIGlmICh0aGlzLmNvbXBDZHIpIHtcbiAgICAgIHRoaXMuY29tcENkci5tYXJrRm9yQ2hlY2soKTtcbiAgICB9XG5cbiAgICB0aGlzLm5vdGlmeU9uSW5wdXRDaGFuZ2VzKHRoaXMubGFzdElucHV0Q2hhbmdlcywgaXNGaXJzdENoYW5nZSk7XG4gIH1cblxuICBwcml2YXRlIGJpbmRPdXRwdXRzKCkge1xuICAgIHRoaXMuX2Rpc2Nvbm5lY3RPdXRwdXRzKCk7XG5cbiAgICBjb25zdCBjb21wSW5zdCA9IHRoaXMuY29tcG9uZW50SW5zdDtcbiAgICBsZXQgb3V0cHV0cyA9IHRoaXMub3V0cHV0cztcblxuICAgIGlmICghb3V0cHV0cyB8fCAhY29tcEluc3QpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBvdXRwdXRzID0gdGhpcy5fcmVzb2x2ZU91dHB1dHMob3V0cHV0cyk7XG5cbiAgICBPYmplY3Qua2V5cyhvdXRwdXRzKVxuICAgICAgLmZpbHRlcihwID0+IGNvbXBJbnN0W3BdKVxuICAgICAgLmZvckVhY2gocCA9PlxuICAgICAgICBjb21wSW5zdFtwXVxuICAgICAgICAgIC5waXBlKHRha2VVbnRpbCh0aGlzLm91dHB1dHNTaG91bGREaXNjb25uZWN0JCkpXG4gICAgICAgICAgLnN1YnNjcmliZSgoZXZlbnQ6IGFueSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5jZHIubWFya0ZvckNoZWNrKCk7XG4gICAgICAgICAgICByZXR1cm4gKG91dHB1dHNbcF0gYXMgRXZlbnRIYW5kbGVyKShldmVudCk7XG4gICAgICAgICAgfSksXG4gICAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBub3RpZnlPbklucHV0Q2hhbmdlcyhcbiAgICBjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzID0ge30sXG4gICAgZm9yY2VGaXJzdENoYW5nZXM6IGJvb2xlYW4sXG4gICkge1xuICAgIC8vIEV4aXQgZWFybHkgaWYgY29tcG9uZW50IG5vdCBpbnRlcmVzdGVkIHRvIHJlY2VpdmUgY2hhbmdlc1xuICAgIGlmICghdGhpcy5jb21wb25lbnRJbnN0Lm5nT25DaGFuZ2VzKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKGZvcmNlRmlyc3RDaGFuZ2VzKSB7XG4gICAgICBjaGFuZ2VzID0gdGhpcy5fY29sbGVjdEZpcnN0Q2hhbmdlcygpO1xuICAgIH1cblxuICAgIHRoaXMuY29tcG9uZW50SW5zdC5uZ09uQ2hhbmdlcyhjaGFuZ2VzKTtcbiAgfVxuXG4gIHByaXZhdGUgX2Rpc2Nvbm5lY3RPdXRwdXRzKCkge1xuICAgIHRoaXMub3V0cHV0c1Nob3VsZERpc2Nvbm5lY3QkLm5leHQoKTtcbiAgfVxuXG4gIHByaXZhdGUgX2dldElucHV0c0NoYW5nZXMoKTogS2V5VmFsdWVDaGFuZ2VzQW55IHtcbiAgICByZXR1cm4gdGhpcy5pbnB1dHNEaWZmZXIuZGlmZih0aGlzLmlucHV0cyk7XG4gIH1cblxuICBwcml2YXRlIF91cGRhdGVJbnB1dENoYW5nZXMoZGlmZmVyOiBLZXlWYWx1ZUNoYW5nZXNBbnkpIHtcbiAgICB0aGlzLmxhc3RJbnB1dENoYW5nZXMgPSB0aGlzLl9jb2xsZWN0Q2hhbmdlc0Zyb21EaWZmZXIoZGlmZmVyKTtcbiAgfVxuXG4gIHByaXZhdGUgX2NvbGxlY3RGaXJzdENoYW5nZXMoKTogU2ltcGxlQ2hhbmdlcyB7XG4gICAgY29uc3QgY2hhbmdlcyA9IHt9IGFzIFNpbXBsZUNoYW5nZXM7XG4gICAgY29uc3QgaW5wdXRzID0gdGhpcy5pbnB1dHM7XG5cbiAgICBPYmplY3Qua2V5cyhpbnB1dHMpLmZvckVhY2goXG4gICAgICBwcm9wID0+IChjaGFuZ2VzW3Byb3BdID0gY3JlYXRlTmV3Q2hhbmdlKGlucHV0c1twcm9wXSkpLFxuICAgICk7XG5cbiAgICByZXR1cm4gdGhpcy5fcmVzb2x2ZUNoYW5nZXMoY2hhbmdlcyk7XG4gIH1cblxuICBwcml2YXRlIF9jb2xsZWN0Q2hhbmdlc0Zyb21EaWZmZXIoZGlmZmVyOiBLZXlWYWx1ZUNoYW5nZXNBbnkpOiBTaW1wbGVDaGFuZ2VzIHtcbiAgICBjb25zdCBjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzID0ge307XG5cbiAgICBkaWZmZXIuZm9yRWFjaEFkZGVkSXRlbShcbiAgICAgIHJlY29yZCA9PiAoY2hhbmdlc1tyZWNvcmQua2V5XSA9IGNyZWF0ZU5ld0NoYW5nZShyZWNvcmQuY3VycmVudFZhbHVlKSksXG4gICAgKTtcblxuICAgIGRpZmZlci5mb3JFYWNoQ2hhbmdlZEl0ZW0oXG4gICAgICByZWNvcmQgPT5cbiAgICAgICAgKGNoYW5nZXNbcmVjb3JkLmtleV0gPSBjcmVhdGVDaGFuZ2UoXG4gICAgICAgICAgcmVjb3JkLmN1cnJlbnRWYWx1ZSxcbiAgICAgICAgICByZWNvcmQucHJldmlvdXNWYWx1ZSxcbiAgICAgICAgKSksXG4gICAgKTtcblxuICAgIHJldHVybiB0aGlzLl9yZXNvbHZlQ2hhbmdlcyhjaGFuZ2VzKTtcbiAgfVxuXG4gIHByaXZhdGUgX3Jlc29sdmVDb21wRmFjdG9yeSgpOiBDb21wb25lbnRGYWN0b3J5PGFueT4gfCBudWxsIHtcbiAgICB0cnkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY2ZyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KHRoaXMuY29tcFJlZi5jb21wb25lbnRUeXBlKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgLy8gRmFsbGJhY2sgaWYgY29tcG9uZW50VHlwZSBkb2VzIG5vdCBleGlzdCAoaGFwcGVucyBvbiBOZ0NvbXBvbmVudE91dGxldClcbiAgICAgICAgcmV0dXJuIHRoaXMuY2ZyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KFxuICAgICAgICAgIHRoaXMuY29tcFJlZi5pbnN0YW5jZS5jb25zdHJ1Y3RvcixcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAvLyBGYWN0b3J5IG5vdCBhdmFpbGFibGUgLSBiYWlsb3V0XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF91cGRhdGVDb21wRmFjdG9yeSgpIHtcbiAgICB0aGlzLmNvbXBGYWN0b3J5ID0gdGhpcy5fcmVzb2x2ZUNvbXBGYWN0b3J5KCk7XG4gIH1cblxuICBwcml2YXRlIF9yZXNvbHZlSW5wdXRzKGlucHV0czogSW5wdXRzVHlwZSk6IElucHV0c1R5cGUge1xuICAgIGlmICghdGhpcy5jb21wRmFjdG9yeSkge1xuICAgICAgcmV0dXJuIGlucHV0cztcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5fcmVtYXBJTyhpbnB1dHMsIHRoaXMuY29tcEZhY3RvcnkuaW5wdXRzKTtcbiAgfVxuXG4gIHByaXZhdGUgX3Jlc29sdmVPdXRwdXRzKG91dHB1dHM6IE91dHB1dHNUeXBlKTogT3V0cHV0c1R5cGUge1xuICAgIG91dHB1dHMgPSB0aGlzLl9wcm9jZXNzT3V0cHV0cyhvdXRwdXRzKTtcblxuICAgIGlmICghdGhpcy5jb21wRmFjdG9yeSkge1xuICAgICAgcmV0dXJuIG91dHB1dHM7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuX3JlbWFwSU8ob3V0cHV0cywgdGhpcy5jb21wRmFjdG9yeS5vdXRwdXRzKTtcbiAgfVxuXG4gIHByaXZhdGUgX3Byb2Nlc3NPdXRwdXRzKG91dHB1dHM6IE91dHB1dHNUeXBlKTogT3V0cHV0c1R5cGVQcm9jZXNzZWQge1xuICAgIGNvbnN0IHByb2Nlc3NlZE91dHB1dHM6IE91dHB1dHNUeXBlUHJvY2Vzc2VkID0ge307XG5cbiAgICBPYmplY3Qua2V5cyhvdXRwdXRzKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICBjb25zdCBvdXRwdXRFeHByID0gb3V0cHV0c1trZXldO1xuXG4gICAgICBpZiAodHlwZW9mIG91dHB1dEV4cHIgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgcHJvY2Vzc2VkT3V0cHV0c1trZXldID0gb3V0cHV0RXhwcjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHByb2Nlc3NlZE91dHB1dHNba2V5XSA9XG4gICAgICAgICAgb3V0cHV0RXhwciAmJiB0aGlzLl9wcm9jZXNzT3V0cHV0QXJncyhvdXRwdXRFeHByKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiBwcm9jZXNzZWRPdXRwdXRzO1xuICB9XG5cbiAgcHJpdmF0ZSBfcHJvY2Vzc091dHB1dEFyZ3Mob3V0cHV0OiBPdXRwdXRXaXRoQXJncyk6IEV2ZW50SGFuZGxlciB7XG4gICAgY29uc3QgeyBoYW5kbGVyIH0gPSBvdXRwdXQ7XG4gICAgY29uc3QgYXJncyA9ICdhcmdzJyBpbiBvdXRwdXQgPyBvdXRwdXQuYXJncyB8fCBbXSA6IFt0aGlzLmV2ZW50QXJndW1lbnRdO1xuXG4gICAgcmV0dXJuIGV2ZW50ID0+XG4gICAgICBoYW5kbGVyKC4uLmFyZ3MubWFwKGFyZyA9PiAoYXJnID09PSB0aGlzLmV2ZW50QXJndW1lbnQgPyBldmVudCA6IGFyZykpKTtcbiAgfVxuXG4gIHByaXZhdGUgX3Jlc29sdmVDaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiBTaW1wbGVDaGFuZ2VzIHtcbiAgICBpZiAoIXRoaXMuY29tcEZhY3RvcnkpIHtcbiAgICAgIHJldHVybiBjaGFuZ2VzO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLl9yZW1hcElPKGNoYW5nZXMsIHRoaXMuY29tcEZhY3RvcnkuaW5wdXRzKTtcbiAgfVxuXG4gIHByaXZhdGUgX3JlbWFwSU88VCBleHRlbmRzIFJlY29yZDxzdHJpbmcsIGFueT4+KFxuICAgIGlvOiBULFxuICAgIG1hcHBpbmc6IElPTWFwcGluZ0xpc3QsXG4gICk6IFQge1xuICAgIGNvbnN0IG5ld0lPID0ge307XG5cbiAgICBPYmplY3Qua2V5cyhpbykuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgY29uc3QgbmV3S2V5ID0gdGhpcy5fZmluZFByb3BCeVRwbEluTWFwcGluZyhrZXksIG1hcHBpbmcpIHx8IGtleTtcbiAgICAgIG5ld0lPW25ld0tleV0gPSBpb1trZXldO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIG5ld0lPIGFzIFQ7XG4gIH1cblxuICBwcml2YXRlIF9maW5kUHJvcEJ5VHBsSW5NYXBwaW5nKFxuICAgIHRwbE5hbWU6IHN0cmluZyxcbiAgICBtYXBwaW5nOiBJT01hcHBpbmdMaXN0LFxuICApOiBzdHJpbmcgfCBudWxsIHtcbiAgICBmb3IgKGNvbnN0IG1hcCBvZiBtYXBwaW5nKSB7XG4gICAgICBpZiAobWFwLnRlbXBsYXRlTmFtZSA9PT0gdHBsTmFtZSkge1xuICAgICAgICByZXR1cm4gbWFwLnByb3BOYW1lO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHByaXZhdGUgZmFpbEluaXQoKSB7XG4gICAgdGhyb3cgRXJyb3IoXG4gICAgICAnSW9TZXJ2aWNlOiBDb21wb25lbnRJbmplY3RvciB3YXMgbm90IHNldCEgUGxlYXNlIGNhbGwgaW5pdCgpIG1ldGhvZCEnLFxuICAgICk7XG4gIH1cbn1cbiJdfQ==